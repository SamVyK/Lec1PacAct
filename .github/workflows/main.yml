name: Lecture 2 Workflow

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

# Give the workflow permission to push commits
permissions:
  contents: write

jobs:
  update-site:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git identity
        shell: bash
        run: |
          git config --global user.name  "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # Skip making changes when the actor is the bot itself to avoid infinite loops
      - name: Decide whether to modify files
        id: should_run
        shell: bash
        run: |
          if [[ "${GITHUB_ACTOR}" == "github-actions[bot]" ]]; then
            echo "run=false" >> "$GITHUB_OUTPUT"
          else
            echo "run=true" >> "$GITHUB_OUTPUT"
          fi

      # Map the actor to a personal HTML file (edit cases to match your team)
      - name: Resolve actor->file mapping
        id: map
        if: steps.should_run.outputs.run == 'true'
        shell: bash
        run: |
          actor="${GITHUB_ACTOR}"
          target_file=""
          case "$actor" in
            TeamLeader) target_file="index.html" ;;
            SamVyK)     target_file="member1.html" ;;
            AliceDev)   target_file="member2.html" ;;
            *)          target_file="" ;;
          esac
          echo "actor=$actor" >> "$GITHUB_OUTPUT"
          echo "target_file=$target_file" >> "$GITHUB_OUTPUT"

      - name: Ensure base files exist
        if: steps.should_run.outputs.run == 'true'
        shell: bash
        run: |
          # Create index.html if missing (simple skeleton)
          if [[ ! -f index.html ]]; then
            cat > index.html <<'HTML'
<!doctype html>
<html>
  <head><meta charset="utf-8"><title>Lecture 2</title></head>
  <body><h1>Lecture 2</h1></body>
</html>
HTML
          fi
          # Create README if missing
          [[ -f README.md ]] || echo "# Lecture 2 log" > README.md

      - name: Update index.html with actor + timestamp
        if: steps.should_run.outputs.run == 'true'
        shell: bash
        run: |
          date_str="$(date '+%Y-%m-%d %H:%M:%S')"
          if grep -q '</body>' index.html; then
            # Insert before </body>
            sed -i "/<\/body>/i <p>Updated by ${GITHUB_ACTOR} on ${date_str}</p>" index.html
          else
            echo "<p>Updated by ${GITHUB_ACTOR} on ${date_str}</p>" >> index.html
          fi

      - name: Update actor-specific HTML (conditional)
        if: steps.should_run.outputs.run == 'true' && steps.map.outputs.target_file != '' && steps.map.outputs.target_file != 'index.html'
        shell: bash
        run: |
          f="${{ steps.map.outputs.target_file }}"
          date_str="$(date '+%Y-%m-%d %H:%M:%S')"
          [[ -f "$f" ]] || echo "<!doctype html><body><h1>${GITHUB_ACTOR}</h1></body>" > "$f"
          if grep -q '</body>' "$f"; then
            sed -i "/<\/body>/i <p>Updated by ${GITHUB_ACTOR} on ${date_str}</p>" "$f"
          else
            echo "<p>Updated by ${GITHUB_ACTOR} on ${date_str}</p>" >> "$f"
          fi

      - name: Log to README
        if: steps.should_run.outputs.run == 'true'
        shell: bash
        run: |
          echo "### Updated by ${GITHUB_ACTOR} on $(date '+%Y-%m-%d %H:%M:%S') [Commit: $(git rev-parse --short HEAD)]" >> README.md

      - name: Commit and push (if there are changes)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          # If we decided to skip edits (bot actor), don't try to commit
          if [[ "${{ steps.should_run.outputs.run }}" != "true" ]]; then
            echo "Skipping commit on bot-triggered run."
            exit 0
          fi

          # Only commit when something actually changed
          if ! git diff --quiet; then
            git add -A
            git commit -m "Workflow: update by ${GITHUB_ACTOR}"
            git push
          else
            echo "No changes to commit."
          fi
